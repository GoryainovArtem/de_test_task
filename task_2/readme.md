# Задание 2 
### Концептуальная схема
![схема](./task_2.svg)

### Общий план работы:
- Инфраструктурные сервисы "1" и клиентские приложения "2" пишут логи.
- Fluent bit "3" собирает, фильтрует логи по уровню логирования CRITICAL и отправляет соответствующие сообщения во внешние системы: 

"4" - PostgreSQL для аналитики критических

"5" - Loki для агрегации всех логов и визуализации в Grafana "7". Хранение логов из Loki происходит в S3 "6"

"8" - Система оповещений


### Комментарии:
1) #### Инфраструктурные сервисы
NGINX, базы данных (PostgreSQL, Oracle и т.д.), Docker и т.д., которые пишут технические логи

2) #### Backend приложения
Пишут клиентские логи

3) #### Fluent-bit
Fluent-bit - инструмент для сбора и фильтрации логов из различных источников, в которой можно настроить маршрутизацию логов во внешние системы по определенным правилам. В нашем случае необходимо настроить фильтрацию логов по уровню логирования (отфильровывать CRITICAL) и отправку таких логов в PostgreSQL и систему оповещений через дополнительные плагины:

Дополнительно необходимо:
- установить PostgreSQL Output plugin для отправки сообщений в PostgreSQL
- установить HTTP output plugin для отправки логов в систему уведомлений по протоколу HTTP


4) #### Реляционная база данных 
Нужна для хранения и анализа критических ошибок. При выборе такого инструмента нужно обратить внимание на следующие факторы:

- Существует ли на текущий момент готовая аналитическая система в компании. Если такая есть, то эффективнее использовать ее как единое хранилище информации и загружать данные сразу туда (+ есть готовые коннекторы к BI, можно построить дашборд)
- Реляционная СУБД подходит хорошо и для единичной вставки сообщений об ошибках (если при настройке Fluent-bit не увеличить размер чанка через параметр) и для последующего анализа НЕБОЛЬШОГО количества данных, а критических ошибок должно быть немного. Будем использовать PostgreSQL для этой задачи
 
Дополнительно необходимо будет настроить бэкапирование данных в S3 (сервис 7)

5) #### Loki
Loki - система агрегации логов. Fluent-bit поддерживает нативную запись логов в Loki.
Позволяет физически хранить данные в локальной файловой системе, S3. Настраивается через storage_config

Будем использовать S3:
- Локальная файловая система сильно проигрывает в параметре "масштабируемость" S3
- HDFS не поддерживается Loki + HDFS будет тянуть за собой другие инструменты экосистемы Hadoop

6) #### S3
Плюсы:
- Низкая стоимость
- Масштабируемость
- Возможность реиспользования в других системах, например, для хранения бэкапов сервиса "4"

Реализация:
- on prem: Minio
- cloud: Yandex cloud S3

7) #### Grafana
Grafana - система визуализации и мониторинга

8) #### Система оповещений
Реализация:
- TG
- Корпоративный мессенджер (Mattermost)
- Сервисы рассылки по почте

